<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>성민아 공부해</title>
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; --accent: #10b981; --error: #ef4444; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; text-align: center; padding: 20px; margin:0; -webkit-touch-callout:none; }
    .container { max-width: 500px; margin: auto; padding: 25px; background: var(--card); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    
    /* 뱃지 및 상태 */
    #badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; }
    .badge-need { background: #f59e0b; color: #000; }
    .badge-done { background: var(--accent); color: #fff; }

    /* 단어 표시 영역 */
    #word { font-size: 2.5rem; font-weight: bold; margin: 10px 0; min-height: 3.5rem; word-break: break-all; display: flex; align-items: center; justify-content: center; }
    #pos { color: #94a3b8; margin-bottom: 25px; height: 1.2rem; font-style: italic; }
    
    /* 입력창 및 버튼 */
    input[type="text"] { width: 90%; padding: 14px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 1.1rem; margin-bottom: 20px; outline: none; transition: 0.3s; }
    input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
    button { padding: 14px 30px; font-size: 1.1rem; border-radius: 12px; border: none; cursor: pointer; background: var(--primary); color: white; font-weight: bold; width: 100%; max-width: 200px; }
    
    /* 결과 색상 */
    .correct { color: #4ade80 !important; }
    .wrong { color: #f87171 !important; }
    #status { margin-top: 25px; font-size: 0.9rem; color: #94a3b8; border-top: 1px solid #334155; padding-top: 15px; }

    /* 관리 모드 레이아웃 */
    #configArea { margin-top: 20px; display: none; background: #000; padding: 15px; border-radius: 15px; border: 1px solid #444; text-align: left; }
    .section-title { font-size: 0.85rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; display: block; }
    textarea { width: 100%; height: 100px; background: #111; color: #4ade80; font-family: monospace; border: 1px solid #444; border-radius: 8px; padding: 10px; box-sizing: border-box; font-size: 0.75rem; margin-bottom: 10px; }
    .admin-btn { padding: 10px; font-size: 0.8rem; border-radius: 8px; margin-bottom: 10px; width: 100%; border: none; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

  <div class="container">
    <div id="badge"></div>
    <div id="word">단어를 추가하시오.</div>
    <div id="pos"></div>
    
    <input type="text" id="inputBox" placeholder="정답 입력..." autocomplete="off" autocapitalize="off">
    <br>
    <button id="mainBtn">확인</button>

    <div id="status">오늘 학습량: <span id="j4Count">0</span></div>
    
    <button onclick="toggleConfig()" style="margin-top:40px; font-size:0.75rem; background:#475569; width: auto; padding: 8px 15px;">데이터 관리</button>

    <div id="configArea">
        <span class="section-title">시트 데이터 복사/붙여넣기</span>
        <textarea id="bulkInput" placeholder="시트에서 [영어 | 뜻 | 발음] 영역을 복사해 넣으시오."></textarea>
        <button class="admin-btn" style="background: var(--accent); color: #000;" onclick="addBulkWords()">선택 단어 일괄 등록</button>

        <div style="border-top: 1px solid #333; margin: 15px 0;"></div>

        <span class="section-title">데이터 백업 (JSON)</span>
        <textarea id="dataOutput" readonly onclick="this.select()"></textarea>
        <button class="admin-btn" style="background: #64748b; color: white;" onclick="copyBackup()">전체 데이터 복사하기</button>
        <button class="admin-btn" style="background: var(--error); color: white;" onclick="resetDB()">학습 기록 초기화</button>
    </div>
  </div>

<script>
let db = JSON.parse(localStorage.getItem('wordDB')) || [];
let stats = JSON.parse(localStorage.getItem('wordStats')) || { todayCount: 0, lastDate: "" };
let currentIndex = 0; // 이제 항상 0번부터 시작해도 됩니다. 정렬이 완벽하니까요.
let mode = "QUIZ";

const todayStr = new Date().toDateString();
if (stats.lastDate !== todayStr) { stats.todayCount = 0; stats.lastDate = todayStr; saveStats(); }

const wordEl = document.getElementById('word');
const posEl = document.getElementById('pos');
const badgeEl = document.getElementById('badge');
const inputEl = document.getElementById('inputBox');
const btnEl = document.getElementById('mainBtn');
const j4El = document.getElementById('j4Count');

function saveDB() { localStorage.setItem('wordDB', JSON.stringify(db)); }
function saveStats() { localStorage.setItem('wordStats', JSON.stringify(stats)); }

function toggleConfig() {
    const area = document.getElementById('configArea');
    if (area.style.display === 'none' || area.style.display === '') {
        area.style.display = 'block';
        document.getElementById('dataOutput').value = JSON.stringify(db);
        area.scrollIntoView({ behavior: 'smooth' });
    } else { area.style.display = 'none'; }
}

// --- 핵심: 더 강력해진 정렬 로직 ---
function reorder() {
    db.sort((a, b) => {
        // 1순위: '학습 필요(need)'가 true인 것을 무조건 앞으로
        if (a.need !== b.need) return a.need ? -1 : 1;
        
        // 2순위: '마지막 체크'에서 틀린 것(false)을 앞으로
        if (a.lastCheck !== b.lastCheck) return a.lastCheck ? 1 : -1;
        
        // 3순위: 한 번도 안 본 단어(lastDate 없음)를 우선
        if (!a.lastDate && b.lastDate) return -1;
        if (a.lastDate && !b.lastDate) return 1;
        
        // 4순위: 본 지 오래된 순서대로
        return new Date(a.lastDate) - new Date(b.lastDate);
    });
    saveDB();
}

function loadQuestion() {
    if (db.length === 0) {
        wordEl.innerText = "단어를 추가하시오.";
        return;
    }

    // 접속할 때나 문제를 불러올 때 항상 정렬을 수행하여 "안 한 것"을 0번으로 보냄
    reorder(); 
    currentIndex = 0; 

    const item = db[currentIndex];
    wordEl.innerText = item.word;
    wordEl.className = "";
    posEl.innerText = item.pos ? "(" + item.pos + ")" : "";
    inputEl.value = "";
    inputEl.style.display = "inline-block";
    btnEl.innerText = "확인";
    j4El.innerText = stats.todayCount;
    badgeEl.innerText = item.need ? "학습 필요" : "학습 완료";
    badgeEl.className = item.need ? "badge-need" : "badge-done";
    mode = "QUIZ";
    inputEl.focus();
}

function submitAnswer() {
    const item = db[currentIndex];
    const userAns = inputEl.value.replace(/[~\- ]/g, "").toLowerCase();
    const answers = item.meaning.split(",").map(s => s.trim().replace(/ /g, "").toLowerCase());
    const isCorrect = userAns !== "" && userAns.split(",").every(v => answers.includes(v));

    item.count++;
    if (isCorrect) {
        item.correct++; item.lastCheck = true; item.need = false; stats.todayCount++;
    } else {
        item.lastCheck = false; item.need = true;
    }
    item.lastDate = new Date().toISOString();
    item.rate = Math.round((item.correct / item.count * 100) * 10) / 10;

    wordEl.innerText = item.meaning;
    wordEl.className = isCorrect ? "correct" : "wrong";
    
    saveDB(); 
    saveStats();
    mode = "REVIEW";
    btnEl.innerText = "다음 문제";
    inputEl.style.display = "none";
}

// 관리 기능들
function addBulkWords() {
    const input = document.getElementById('bulkInput').value.trim();
    if (!input) return alert("내용을 입력하시오.");
    const lines = input.split('\n');
    let added = 0;
    lines.forEach(line => {
        const parts = line.split('\t');
        if (parts.length >= 2) {
            const word = parts[0].trim();
            if (word && !db.some(item => item.word === word)) {
                db.unshift({
                    word: word, meaning: parts[1].trim(), pos: parts[2] ? parts[2].trim() : "",
                    lastDate: null, count: 0, correct: 0, rate: 0, lastCheck: false, need: true
                });
                added++;
            }
        }
    });
    if(added > 0) { saveDB(); alert(added + "개 추가 완료."); location.reload(); }
}

function copyBackup() {
    const output = document.getElementById('dataOutput');
    output.select();
    document.execCommand('copy');
    alert("복사되었습니다.");
}

function resetDB() {
    if(confirm("초기화할까요?")) { localStorage.clear(); location.reload(); }
}

btnEl.onclick = () => { 
    if (mode === "QUIZ") submitAnswer(); 
    else loadQuestion(); // 다음 문제를 누르면 다시 정렬 후 0번(제일 급한 단어)을 호출
};

inputEl.onkeypress = (e) => { if(e.key === 'Enter') btnEl.onclick(); };

window.onload = loadQuestion;
</script>
</body>
</html>