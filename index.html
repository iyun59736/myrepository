<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>퀴즈 제작기</title>
</head>
<body>
  <h1>카테고리 선택</h1>
  <div id="categories"></div>
  <button onclick="startQuiz()">퀴즈 시작</button>

  <div id="quiz" style="display:none;">
    <p id="question"></p>
    <div id="options"></div>
    <button onclick="nextStep()">다음</button>
  </div>

  <div id="result" style="display:none;"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1DdlZ6NbsDBzKhGATyxCVdrU5bCqKPPEDiO4CUGpheGU/gviz/tq?tqx=out:json";
    let allData = [], filteredQuestions = [], currentQuestion = 0, correctCount = 0;
    let state = "answer"; // or "next"
    let selectedCategories = [];

    async function loadSheetData() {
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2)); // clean up JSONP

      const rows = json.table.rows;
      allData = rows.map(row => ({
        question: row.c[0]?.v,
        answer: row.c[1]?.v,
        category: row.c[2]?.v
      })).filter(q => q.question && q.answer && q.category);

      const uniqueCategories = [...new Set(allData.map(q => q.category))];
      const catDiv = document.getElementById('categories');
      uniqueCategories.forEach(cat => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${cat}"> ${cat}`;
        catDiv.appendChild(label);
        catDiv.appendChild(document.createElement('br'));
      });
    }

    function startQuiz() {
      const checkboxes = document.querySelectorAll('#categories input:checked');
      selectedCategories = Array.from(checkboxes).map(cb => cb.value);

      filteredQuestions = allData.filter(q => selectedCategories.includes(q.category));
      shuffleArray(filteredQuestions);
      currentQuestion = 0;
      correctCount = 0;
      document.getElementById('quiz').style.display = 'block';
      document.getElementById('result').style.display = 'none';
      showQuestion();
    }

    function showQuestion() {
      const q = filteredQuestions[currentQuestion];
      document.getElementById('question').innerText = q.question;

      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = '';
      const options = generateOptions(q.answer);
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.onclick = () => {
          if (state === "answer") {
            if (opt === q.answer) {
              btn.style.background = "lightgreen";
              correctCount++;
            } else {
              btn.style.background = "pink";
            }
            state = "next";
          }
        };
        optionsDiv.appendChild(btn);
      });
    }

    function nextStep() {
      if (state === "answer") return; // 아직 정답 안 고름
      currentQuestion++;
      if (currentQuestion >= filteredQuestions.length) {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('result').innerText = `맞춘 개수: ${correctCount}/${filteredQuestions.length}`;
        state = "answer";
      } else {
        state = "answer";
        showQuestion();
      }
    }

    function generateOptions(correct) {
      const pool = filteredQuestions.map(q => q.answer).filter(a => a !== correct);
      shuffleArray(pool);
      const choices = pool.slice(0, 3);
      choices.push(correct);
      shuffleArray(choices);
      return choices;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    loadSheetData();
  </script>
</body>
</html>
